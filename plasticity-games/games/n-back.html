<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>N-Back</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050509;
      color: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 480px;
      padding: 24px;
      box-sizing: border-box;
      border-radius: 16px;
      background: radial-gradient(circle at top, #0b1120, #020617);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 1.4rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }
    #instructions {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 16px;
    }
    #gameArea {
      min-height: 160px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    #status {
      margin-top: 8px;
      font-size: 0.8rem;
      opacity: 0.75;
    }
    #feedback {
      margin-top: 6px;
      font-size: 0.85rem;
    }
    button.primary {
      margin-top: 12px;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #38bdf8, #a855f7);
      color: white;
      box-shadow: 0 10px 30px rgba(56, 189, 248, 0.35);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>N-Back</h1>
    <div id="instructions"></div>
    <div id="gameArea">
      <span id="placeholderText">Game area for N-Back.</span>
    </div>
    <button id="startButton" class="primary">Start</button>
    <div id="status"></div>
    <div id="feedback"></div>
  </div>

  <script src="../shared/plasticityGame.js"></script>
  <script>
    var config, difficultyLevel, nBack;
    var totalTrials, interStimulusIntervalMs;
    var sequence = [];
    var currentTrialIndex = -1;
    var isRunning = false;
    var awaitingResponse = false;
    var trialStartTime = null;

    var numTrials = 0;
    var numTargets = 0;
    var numHits = 0;
    var numMisses = 0;
    var numFalseAlarms = 0;
    var reactionTimes = [];

    var startButtonAttached = false;
    var trialTimerId = null;

    function initGame(configObj) {
      config = configObj || {};
      PlasticityGame.init(config);

      difficultyLevel = config.difficultyLevel || 1;
      if (difficultyLevel === 1) {
        nBack = 1;
        totalTrials = 20;
        interStimulusIntervalMs = 2000;
      } else if (difficultyLevel === 2) {
        nBack = 2;
        totalTrials = 25;
        interStimulusIntervalMs = 2000;
      } else {
        nBack = 3;
        totalTrials = 30;
        interStimulusIntervalMs = 1800;
      }

      var instructions = document.getElementById("instructions");
      instructions.textContent =
        "Press MATCH whenever the current letter is the same as the one " +
        nBack +
        " positions back.";

      var status = document.getElementById("status");
      status.textContent = "N = " + nBack + " (" + nBack + "-back), " + totalTrials + " trials";

      document.getElementById("feedback").textContent = "";
      resetState();

      var startButton = document.getElementById("startButton");
      startButton.textContent = "Start";
      startButton.disabled = false;

      if (!startButtonAttached) {
        startButton.addEventListener("click", handleStartOrMatch);
        startButtonAttached = true;
      }
    }

    function resetState() {
      sequence = [];
      currentTrialIndex = -1;
      isRunning = false;
      awaitingResponse = false;
      trialStartTime = null;
      numTrials = 0;
      numTargets = 0;
      numHits = 0;
      numMisses = 0;
      numFalseAlarms = 0;
      reactionTimes = [];

      if (trialTimerId) {
        clearTimeout(trialTimerId);
        trialTimerId = null;
      }
    }

    function randomLetter() {
      var letters = ["A", "B", "C", "D", "E", "F", "G", "H"];
      return letters[Math.floor(Math.random() * letters.length)];
    }

    function isTargetTrial(index) {
      if (index < nBack) return false;
      return sequence[index] === sequence[index - nBack];
    }

    function handleStartOrMatch() {
      if (!isRunning) {
        startGame();
      } else {
        handleMatchResponse();
      }
    }

    function startGame() {
      if (isRunning) return;
      resetState();
      isRunning = true;
      document.getElementById("feedback").textContent = "";
      var startButton = document.getElementById("startButton");
      startButton.textContent = "MATCH";
      startButton.disabled = false;

      setTimeout(runNextTrial, 500);
    }

    function runNextTrial() {
      currentTrialIndex += 1;

      if (currentTrialIndex >= totalTrials) {
        endGame();
        return;
      }

      numTrials += 1;
      var currentLetter = generateLetter();
      renderStimulus(currentLetter);

      awaitingResponse = true;
      trialStartTime = performance.now();

      trialTimerId = setTimeout(function () {
        handleTrialTimeout(currentTrialIndex);
      }, interStimulusIntervalMs);
    }

    function generateLetter() {
      var letter;
      if (currentTrialIndex < nBack) {
        letter = randomLetter();
      } else {
        var makeTarget = Math.random() < 0.3;
        if (makeTarget) {
          letter = sequence[currentTrialIndex - nBack];
        } else {
          var avoid = sequence[currentTrialIndex - nBack];
          do {
            letter = randomLetter();
          } while (letter === avoid);
        }
      }

      sequence.push(letter);
      return letter;
    }

    function renderStimulus(letter) {
      var gameArea = document.getElementById("gameArea");
      gameArea.innerHTML =
        '<span style="font-size: 4rem; letter-spacing: 0.12em;">' +
        letter +
        "</span>";
    }

    function handleMatchResponse() {
      if (!isRunning || !awaitingResponse) return;

      awaitingResponse = false;
      var rt = performance.now() - trialStartTime;
      var target = isTargetTrial(currentTrialIndex);
      var letter = sequence[currentTrialIndex];
      var responseCorrect = false;

      if (target) {
        numHits += 1;
        numTargets += 1;
        reactionTimes.push(rt);
        responseCorrect = true;
        document.getElementById("feedback").textContent = "Hit!";
      } else {
        numFalseAlarms += 1;
        document.getElementById("feedback").textContent = "False alarm";
      }

      PlasticityGame.logEvent({
        type: "TRIAL",
        trialIndex: currentTrialIndex,
        nBack: nBack,
        letter: letter,
        isTarget: target,
        responded: true,
        responseCorrect: responseCorrect,
        rtMs: Math.round(rt)
      });
    }

    function handleTrialTimeout(trialIndex) {
      if (!isRunning || trialIndex !== currentTrialIndex) return;

      if (awaitingResponse) {
        var target = isTargetTrial(trialIndex);
        var letter = sequence[trialIndex];
        var responseCorrect = !target;

        if (target) {
          numMisses += 1;
          numTargets += 1;
          document.getElementById("feedback").textContent = "Miss";
        }

        awaitingResponse = false;

        PlasticityGame.logEvent({
          type: "TRIAL",
          trialIndex: trialIndex,
          nBack: nBack,
          letter: letter,
          isTarget: target,
          responded: false,
          responseCorrect: responseCorrect,
          rtMs: null
        });
      }

      runNextTrial();
    }

    function endGame() {
      isRunning = false;
      awaitingResponse = false;

      var hitRate = numTargets > 0 ? numHits / numTargets : 0;
      var falseAlarmRate = numTrials > 0 ? numFalseAlarms / numTrials : 0;
      var avgRT = reactionTimes.length > 0
        ? reactionTimes.reduce(function (sum, v) { return sum + v; }, 0) / reactionTimes.length
        : null;

      var baseScore = hitRate - falseAlarmRate * 0.5;
      baseScore = Math.max(0, Math.min(1, baseScore));
      var score = Math.round(baseScore * 1000);

      var feedback = "Hits: " + numHits +
        ", Misses: " + numMisses +
        ", False alarms: " + numFalseAlarms +
        ", Hit rate: " + Math.round(hitRate * 100) + "%";

      if (avgRT !== null) {
        feedback += ", Avg RT: " + Math.round(avgRT) + "ms";
      }

      document.getElementById("feedback").textContent = feedback;

      var startButton = document.getElementById("startButton");
      startButton.textContent = "Start";
      startButton.disabled = false;

      PlasticityGame.end({
        score: score,
        accuracy: hitRate,
        numTrials: numTrials,
        numTargets: numTargets,
        numHits: numHits,
        numMisses: numMisses,
        numFalseAlarms: numFalseAlarms,
        avgReactionTimeMs: avgRT,
        nBack: nBack,
        completed: true
      });
    }

    // Standalone debug: auto-init if not inside iframe/ReactNativeWebView
    window.addEventListener("load", function () {
      if (!window.ReactNativeWebView && window.parent === window) {
        initGame({
          gameId: "n-back",
          sessionId: "debug-session-" + Date.now(),
          difficultyLevel: 1,
          timeLimitMs: 600000,
          variant: "prototype"
        });
      }
    });

    // Support INIT_CONFIG via postMessage from parent harness
    window.addEventListener("message", function (event) {
      if (!event || !event.data) return;
      if (event.data.type === "INIT_CONFIG" && event.data.config) {
        initGame(event.data.config);
      }
    });
  </script>
</body>
</html>
