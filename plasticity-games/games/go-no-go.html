<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Go / No-Go</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050509;
      color: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 480px;
      padding: 24px;
      box-sizing: border-box;
      border-radius: 16px;
      background: radial-gradient(circle at top, #0b1120, #020617);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 1.4rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }
    #instructions {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 16px;
    }
    #gameArea {
      min-height: 160px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    #status {
      margin-top: 8px;
      font-size: 0.8rem;
      opacity: 0.75;
    }
    #feedback {
      margin-top: 6px;
      font-size: 0.85rem;
    }
    button.primary {
      margin-top: 12px;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #38bdf8, #a855f7);
      color: white;
      box-shadow: 0 10px 30px rgba(56, 189, 248, 0.35);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Go / No-Go</h1>
    <div id="instructions"></div>
    <div id="gameArea">
      <span id="placeholderText">Game area for Go / No-Go.</span>
    </div>
    <button id="startButton" class="primary">Start</button>
    <div id="status"></div>
    <div id="feedback"></div>
  </div>

  <script src="../shared/plasticityGame.js"></script>
  <script>
    var config = null;
    var difficultyLevel = 1;
    var totalTrials = 0;
    var goProbability = 0.7;
    var interStimulusIntervalMs = 0;
    var responseWindowMs = 0;

    var currentTrialIndex = -1;
    var isRunning = false;
    var awaitingResponse = false;
    var trialStartTime = null;

    var numTrials = 0;
    var numGoTrials = 0;
    var numNoGoTrials = 0;
    var numHits = 0;
    var numMisses = 0;
    var numFalseAlarms = 0;
    var numCorrectRejections = 0;
    var rtHits = [];

    var currentIsGo = false;
    var currentStimulusTimeout = null;
    var responseTimeout = null;

    var instructionsEl = null;
    var gameAreaEl = null;
    var statusEl = null;
    var feedbackEl = null;
    var startButtonEl = null;

    function initGame(initialConfig) {
      config = initialConfig || {};
      PlasticityGame.init(config);

      instructionsEl = document.getElementById("instructions");
      gameAreaEl = document.getElementById("gameArea");
      statusEl = document.getElementById("status");
      feedbackEl = document.getElementById("feedback");
      startButtonEl = document.getElementById("startButton");

      difficultyLevel = config.difficultyLevel || 1;

      if (difficultyLevel === 1) {
        totalTrials = 30;
        goProbability = 0.7;
        interStimulusIntervalMs = 2000;
        responseWindowMs = 1400;
      } else if (difficultyLevel === 2) {
        totalTrials = 35;
        goProbability = 0.65;
        interStimulusIntervalMs = 1800;
        responseWindowMs = 1200;
      } else {
        totalTrials = 40;
        goProbability = 0.6;
        interStimulusIntervalMs = 1600;
        responseWindowMs = 1000;
      }

      currentTrialIndex = -1;
      isRunning = false;
      awaitingResponse = false;
      numTrials = 0;
      numGoTrials = 0;
      numNoGoTrials = 0;
      numHits = 0;
      numMisses = 0;
      numFalseAlarms = 0;
      numCorrectRejections = 0;
      rtHits = [];

      instructionsEl.textContent = "Tap when you see GO (green). Do nothing on STOP (red).";
      statusEl.textContent = "Difficulty " + difficultyLevel + " 路 Trials " + totalTrials;
      feedbackEl.textContent = "";
      startButtonEl.textContent = "Start";
      startButtonEl.disabled = false;

      startButtonEl.onclick = handleStartButton;
    }

    function handleStartButton() {
      if (!isRunning) {
        startGame();
        return;
      }

      if (!awaitingResponse) {
        return;
      }

      var now = performance.now ? performance.now() : Date.now();
      var rtMs = now - trialStartTime;
      awaitingResponse = false;

      var responded = true;
      var responseCorrect = false;
      var responseLabel = "";

      if (currentIsGo) {
        numHits++;
        responseCorrect = true;
        responseLabel = "Hit!";
        rtHits.push(rtMs);
      } else {
        numFalseAlarms++;
        responseCorrect = false;
        responseLabel = "False alarm";
      }

      feedbackEl.textContent = responseLabel;

      PlasticityGame.logEvent({
        type: "TRIAL",
        trialIndex: currentTrialIndex,
        isGo: currentIsGo,
        responded: responded,
        responseCorrect: responseCorrect,
        rtMs: rtMs,
        timestampStimulusOnset: trialStartTime,
        timestampResponse: now
      });
    }

    function showStimulus(isGo) {
      currentIsGo = isGo;
      if (isGo) {
        gameAreaEl.innerHTML = '<div style="font-size:72px; color:#22c55e;">GO</div>';
      } else {
        gameAreaEl.innerHTML = '<div style="font-size:72px; color:#ef4444;">STOP</div>';
      }
      statusEl.textContent = "Trial " + (currentTrialIndex + 1) + " / " + totalTrials + " 路 Difficulty " + difficultyLevel;
    }

    function startGame() {
      if (isRunning) return;

      currentTrialIndex = -1;
      awaitingResponse = false;
      numTrials = 0;
      numGoTrials = 0;
      numNoGoTrials = 0;
      numHits = 0;
      numMisses = 0;
      numFalseAlarms = 0;
      numCorrectRejections = 0;
      rtHits = [];

      isRunning = true;
      feedbackEl.textContent = "";
      startButtonEl.textContent = "GO!";

      if (currentStimulusTimeout) {
        clearTimeout(currentStimulusTimeout);
      }
      if (responseTimeout) {
        clearTimeout(responseTimeout);
      }

      currentStimulusTimeout = setTimeout(function () {
        runNextTrial();
      }, 500);
    }

    function runNextTrial() {
      currentTrialIndex++;

      if (currentTrialIndex >= totalTrials) {
        endGame();
        return;
      }

      numTrials++;

      if (Math.random() < goProbability) {
        currentIsGo = true;
        numGoTrials++;
      } else {
        currentIsGo = false;
        numNoGoTrials++;
      }

      showStimulus(currentIsGo);
      awaitingResponse = true;
      trialStartTime = performance.now ? performance.now() : Date.now();

      if (responseTimeout) {
        clearTimeout(responseTimeout);
      }
      responseTimeout = setTimeout(function () {
        if (!awaitingResponse) {
          return;
        }
        awaitingResponse = false;
        var responded = false;
        var responseCorrect = !currentIsGo;

        if (currentIsGo) {
          numMisses++;
          feedbackEl.textContent = "Miss";
        } else {
          numCorrectRejections++;
          feedbackEl.textContent = "Correct rejection";
        }

        PlasticityGame.logEvent({
          type: "TRIAL",
          trialIndex: currentTrialIndex,
          isGo: currentIsGo,
          responded: responded,
          responseCorrect: responseCorrect,
          rtMs: null,
          timestampStimulusOnset: trialStartTime,
          timestampResponse: null
        });
      }, responseWindowMs);

      if (currentStimulusTimeout) {
        clearTimeout(currentStimulusTimeout);
      }
      currentStimulusTimeout = setTimeout(function () {
        runNextTrial();
      }, interStimulusIntervalMs);
    }

    function endGame() {
      isRunning = false;
      awaitingResponse = false;

      if (currentStimulusTimeout) {
        clearTimeout(currentStimulusTimeout);
      }
      if (responseTimeout) {
        clearTimeout(responseTimeout);
      }

      var numErrors = numMisses + numFalseAlarms;
      var hitRate = numGoTrials > 0 ? numHits / numGoTrials : 0;
      var falseAlarmRate = numNoGoTrials > 0 ? numFalseAlarms / numNoGoTrials : 0;
      var accuracy = numTrials > 0 ? (numHits + numCorrectRejections) / numTrials : 0;
      var avgRt = rtHits.length > 0 ? rtHits.reduce(function (a, b) { return a + b; }, 0) / rtHits.length : null;
      var score = Math.round(accuracy * 1000);

      var summaryLines = [];
      summaryLines.push("Session complete.");
      summaryLines.push("Hits: " + numHits + " 路 Misses: " + numMisses + " 路 False alarms: " + numFalseAlarms);
      summaryLines.push("Accuracy: " + Math.round(accuracy * 100) + "%");
      if (avgRt !== null) {
        summaryLines.push("Avg RT: " + Math.round(avgRt) + " ms");
      }
      feedbackEl.textContent = summaryLines.join(" \u00b7 ");
      startButtonEl.textContent = "Start";

      PlasticityGame.end({
        score: score,
        accuracy: accuracy,
        numTrials: numTrials,
        numGoTrials: numGoTrials,
        numNoGoTrials: numNoGoTrials,
        numHits: numHits,
        numMisses: numMisses,
        numFalseAlarms: numFalseAlarms,
        numCorrectRejections: numCorrectRejections,
        avgReactionTimeMs: avgRt,
        hitRate: hitRate,
        falseAlarmRate: falseAlarmRate,
        numErrors: numErrors,
        completed: true
      });
    }

    window.addEventListener("message", function (event) {
      if (!event || !event.data) return;
      if (event.data.type === "INIT_CONFIG" && event.data.config) {
        initGame(event.data.config);
      }
    });

    window.addEventListener("load", function () {
      if (!window.ReactNativeWebView && window.parent === window) {
        initGame({
          gameId: "go-no-go",
          sessionId: "debug-session-" + Date.now(),
          difficultyLevel: 1,
          timeLimitMs: 60000,
          variant: "prototype"
        });
        startGame();
      }
    });
  </script>
</body>
</html>
