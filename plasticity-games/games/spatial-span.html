<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spatial Span</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050509;
      color: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 480px;
      padding: 24px;
      box-sizing: border-box;
      border-radius: 16px;
      background: radial-gradient(circle at top, #0b1120, #020617);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 1.4rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }
    #instructions {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 16px;
    }
    #gameArea {
      min-height: 160px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    #status {
      margin-top: 8px;
      font-size: 0.8rem;
      opacity: 0.75;
    }
    #feedback {
      margin-top: 6px;
      font-size: 0.85rem;
    }
    button.primary {
      margin-top: 12px;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #38bdf8, #a855f7);
      color: white;
      box-shadow: 0 10px 30px rgba(56, 189, 248, 0.35);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Spatial Span</h1>
    <div id="instructions"></div>
    <div id="gameArea">
      <span id="placeholderText">Game area for Spatial Span.</span>
    </div>
    <button id="startButton" class="primary">Start</button>
    <div id="status"></div>
    <div id="feedback"></div>
  </div>

  <script src="../shared/plasticityGame.js"></script>
  <script>
    var config = null;
    var difficultyLevel = 1;

    var gridSize = 3;
    var cells = [];

    var baseSequenceLength = 0;
    var maxTrials = 0;

    var currentTrialIndex = -1;
    var isRunning = false;
    var isShowingSequence = false;
    var isAwaitingRecall = false;

    var currentSequence = [];
    var recallInputs = [];
    var sequenceStartTime = null;

    var numTrials = 0;
    var numCorrect = 0;
    var numIncorrect = 0;
    var maxSpanAchieved = 0;
    var recallTimes = [];

    var instructionsEl = document.getElementById("instructions");
    var gameAreaEl = document.getElementById("gameArea");
    var statusEl = document.getElementById("status");
    var feedbackEl = document.getElementById("feedback");
    var startButtonEl = document.getElementById("startButton");

    function buildGridIfNeeded() {
      if (cells.length > 0) return;

      var placeholder = document.getElementById("placeholderText");
      if (placeholder) {
        placeholder.remove();
      }

      var grid = document.createElement("div");
      grid.style.display = "grid";
      grid.style.gridTemplateColumns = "repeat(" + gridSize + ", 1fr)";
      grid.style.gridTemplateRows = "repeat(" + gridSize + ", 1fr)";
      grid.style.gap = "8px";
      grid.style.width = "100%";
      grid.style.maxWidth = "240px";
      grid.style.aspectRatio = "1 / 1";

      for (var i = 0; i < gridSize * gridSize; i++) {
        var cell = document.createElement("div");
        cell.setAttribute("data-index", i);
        cell.style.border = "1px solid rgba(148, 163, 184, 0.6)";
        cell.style.borderRadius = "8px";
        cell.style.background = "rgba(51, 65, 85, 0.4)";
        cell.style.transition = "background 0.2s, transform 0.1s";
        cell.style.width = "100%";
        cell.style.height = "100%";
        cell.style.boxSizing = "border-box";
        cell.style.cursor = "pointer";

        (function (index) {
          cell.addEventListener("click", function () {
            handleCellClick(index);
          });
        })(i);

        cells.push(cell);
        grid.appendChild(cell);
      }

      gameAreaEl.innerHTML = "";
      gameAreaEl.appendChild(grid);
    }

    function initGame(initialConfig) {
      config = initialConfig || {};
      PlasticityGame.init(config);

      difficultyLevel = config.difficultyLevel || 1;

      if (difficultyLevel === 1) {
        baseSequenceLength = 3;
        maxTrials = 8;
      } else if (difficultyLevel === 2) {
        baseSequenceLength = 4;
        maxTrials = 8;
      } else {
        baseSequenceLength = 5;
        maxTrials = 8;
      }

      currentTrialIndex = -1;
      isRunning = false;
      isShowingSequence = false;
      isAwaitingRecall = false;
      currentSequence = [];
      recallInputs = [];
      sequenceStartTime = null;
      numTrials = 0;
      numCorrect = 0;
      numIncorrect = 0;
      maxSpanAchieved = 0;
      recallTimes = [];

      buildGridIfNeeded();

      instructionsEl.textContent = "Watch the squares light up, then tap them in the same order.";
      statusEl.textContent = "Difficulty " + difficultyLevel + " · Up to " + maxTrials + " sequences";
      feedbackEl.textContent = "";
      startButtonEl.textContent = "Start";
      startButtonEl.disabled = false;
    }

    function randomCellIndex() {
      return Math.floor(Math.random() * (gridSize * gridSize));
    }

    function highlightCell(index) {
      var cell = cells[index];
      if (!cell) return;
      cell.style.background = "rgba(94, 234, 212, 0.9)";
      cell.style.transform = "scale(1.03)";
    }

    function clearHighlight(index) {
      var cell = cells[index];
      if (!cell) return;
      cell.style.background = "rgba(51, 65, 85, 0.4)";
      cell.style.transform = "scale(1)";
    }

    function startGame() {
      if (isRunning) return;
      if (!config) {
        initGame({
          gameId: "spatial-span",
          sessionId: "debug-session-" + Date.now(),
          difficultyLevel: 1,
          timeLimitMs: 600000,
          variant: "prototype"
        });
      }

      currentTrialIndex = -1;
      isRunning = true;
      isShowingSequence = false;
      isAwaitingRecall = false;
      numTrials = 0;
      numCorrect = 0;
      numIncorrect = 0;
      maxSpanAchieved = 0;
      recallTimes = [];
      feedbackEl.textContent = "";
      startButtonEl.textContent = "Watch...";
      startButtonEl.disabled = true;

      setTimeout(function () {
        runNextTrial();
      }, 600);
    }

    function runNextTrial() {
      currentTrialIndex += 1;

      if (currentTrialIndex >= maxTrials) {
        endGame();
        return;
      }

      numTrials += 1;

      var span = baseSequenceLength + Math.floor(currentTrialIndex / 2);
      var maxExtra = 3;
      var maxSpan = baseSequenceLength + maxExtra;
      if (span > maxSpan) span = maxSpan;

      currentSequence = [];
      for (var i = 0; i < span; i++) {
        currentSequence.push(randomCellIndex());
      }

      isShowingSequence = true;
      isAwaitingRecall = false;
      recallInputs = [];
      sequenceStartTime = null;

      statusEl.textContent = "Sequence " + (currentTrialIndex + 1) + " / " + maxTrials + " · Length " + span;
      feedbackEl.textContent = "Watch the sequence...";

      playSequence(currentSequence, function () {
        isShowingSequence = false;
        isAwaitingRecall = true;
        startButtonEl.textContent = "Repeat the sequence";
        startButtonEl.disabled = true;
        sequenceStartTime = (typeof performance !== "undefined" && performance.now) ? performance.now() : Date.now();
        feedbackEl.textContent = "Now tap the squares in order.";
      });
    }

    function playSequence(sequence, callback) {
      var delay = 0;
      var highlightDuration = 500;
      var gapDuration = 300;

      sequence.forEach(function (index, idx) {
        setTimeout(function () {
          highlightCell(index);
        }, delay);

        setTimeout(function () {
          clearHighlight(index);
        }, delay + highlightDuration);

        delay += highlightDuration + gapDuration;
      });

      setTimeout(function () {
        if (typeof callback === "function") {
          callback();
        }
      }, delay);
    }

    function handleCellClick(index) {
      if (!isRunning || !isAwaitingRecall) return;

      var cell = cells[index];
      if (cell) {
        highlightCell(index);
        setTimeout(function () {
          clearHighlight(index);
        }, 150);
      }

      recallInputs.push(index);

      if (recallInputs.length === currentSequence.length) {
        isAwaitingRecall = false;
        var now = (typeof performance !== "undefined" && performance.now) ? performance.now() : Date.now();
        var recallDurationMs = sequenceStartTime ? (now - sequenceStartTime) : null;
        if (recallDurationMs !== null) {
          recallTimes.push(recallDurationMs);
        }

        var correct = true;
        for (var i = 0; i < currentSequence.length; i++) {
          if (currentSequence[i] !== recallInputs[i]) {
            correct = false;
            break;
          }
        }

        if (correct) {
          numCorrect += 1;
          if (currentSequence.length > maxSpanAchieved) {
            maxSpanAchieved = currentSequence.length;
          }
          feedbackEl.textContent = "Correct!";
        } else {
          numIncorrect += 1;
          feedbackEl.textContent = "Incorrect sequence.";
        }

        PlasticityGame.logEvent({
          type: "TRIAL",
          trialIndex: currentTrialIndex,
          span: currentSequence.length,
          sequence: currentSequence.slice(),
          recall: recallInputs.slice(),
          correct: correct,
          recallDurationMs: recallDurationMs,
          timestampRecallStart: sequenceStartTime,
          timestampRecallEnd: now
        });

        setTimeout(function () {
          runNextTrial();
        }, 600);
      }
    }

    function endGame() {
      isRunning = false;
      isShowingSequence = false;
      isAwaitingRecall = false;
      startButtonEl.textContent = "Start";
      startButtonEl.disabled = false;

      var numTrialsAttempted = numTrials;
      var numErrors = numIncorrect;
      var accuracy = numTrialsAttempted > 0 ? numCorrect / numTrialsAttempted : 0;
      var avgRecallTime = recallTimes.length > 0
        ? recallTimes.reduce(function (a, b) { return a + b; }, 0) / recallTimes.length
        : null;
      var score = Math.round(accuracy * 1000 + maxSpanAchieved * 50);

      feedbackEl.textContent =
        "Sequences correct " + numCorrect + " / " + numTrialsAttempted +
        ", Max span " + maxSpanAchieved +
        ", Accuracy " + Math.round(accuracy * 100) + "%" +
        (avgRecallTime !== null ? ", Avg recall " + Math.round(avgRecallTime) + " ms" : "");

      PlasticityGame.end({
        score: score,
        accuracy: accuracy,
        numTrials: numTrialsAttempted,
        numCorrect: numCorrect,
        numIncorrect: numIncorrect,
        maxSpanAchieved: maxSpanAchieved,
        avgReactionTimeMs: avgRecallTime,
        completed: true
      });
    }

    startButtonEl.addEventListener("click", function () {
      if (!isRunning) {
        startGame();
      }
    });

    window.addEventListener("load", function () {
      if (!window.ReactNativeWebView && window.parent === window) {
        initGame({
          gameId: "spatial-span",
          sessionId: "debug-session-" + Date.now(),
          difficultyLevel: 1,
          timeLimitMs: 600000,
          variant: "prototype"
        });
        // startGame(); // Uncomment to auto-start in standalone debug
      }
    });

    window.addEventListener("message", function (event) {
      if (!event || !event.data) return;
      if (event.data.type === "INIT_CONFIG" && event.data.config) {
        initGame(event.data.config);
      }
    });
  </script>
</body>
</html>
